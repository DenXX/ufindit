{% extends 'serp.html' %}

{% block searchform %}
    <form class="navbar-form" method="GET">
      {% csrf_token %}
      <div class="input-append">
        <input type="text" value="{{ query }}" id="queryText" name="q" size="60" autocomplete="off">
        <button type="submit" class="btn btn-success" id="search" data-loading-text="Searching...">Search</button>
        <button type="button" data-toggle="modal" id="queryDifficultyButton" href="#queryDifficulty" class="btn btn-warning">I can't find the answer!</button>
      </div>
    </form>
{% endblock %}

{% block results %}
  <form method="POST" id="queryUrlProblemForm">
  {% for result in results %}
  <input type="hidden" name="serpid" value="{{ serpid }}">
  <input type="hidden" name="rank" value="{{ forloop.counter0|add:results.start_index }}" />
  <li>
      <div class="nospace"><h3 class="nospace"><a href="{% url 'http_proxy_decorator' task_id=task_id serp_id=serpid url=result.safe_url %}" class="nospace">{{ result.title|safe }}</a></h3></div>
      <div class="nospace"><cite class="search-results-link">{{ result.display_url|safe }}</cite></div>
      <p>{{ result.snippet|safe }}</p>

      <div id="fillFormAlert" class="alert alert-danger hide">If you don't like this result please specify why...</div>

      <table class="table table-bordered" style="width: auto; text-align: center;">
      <tr><th style="padding: 4px">&nbsp;</th>
        {% for term in query_terms %}<th style="padding: 4px">{{ term }}</th> {% endfor %}
      </tr>
      <tr>
        <td style="padding: 4px" class="text-right">Missing topic</td>
        {% for term in query_terms %}
          <td style="padding: 4px">
            <input type="checkbox" name="missing[]" value="{{term}}">
          </td>
        {% endfor %}
      </tr>
      <tr>
        <td style="padding: 4px" class="text-right">Misinterpreted keyword</td>
        {% for term in query_terms %}
          <td style="padding: 4px">
            <input type="checkbox" name="misinterpreted[]" value="{{ term }}">
          </td>
        {% endfor %}
      </tr>
      <tr>
        <td style="padding: 4px" class="text-right">Missing relation between topics</td>
        {% for term in query_terms %}
          <td style="padding: 4px">
            <input type="checkbox" name="missing_relation[]" value="{{ term }}">
          </td>
        {% endfor %}
      </tr>
      </table>
      <div class="form-group">
        <label class="sr-only" for="extra">Other problem</label>
        <input type="text" class="form-control" name="extra" id="extra" placeholder="Other problem?">
      </div>
      <hr />
  </li>
  </form>
  {% endfor %}
{% endblock %}

{% block pager %}
  <ul class="pagination pagination-sm" id="serp_pager">
      <li {% if not results.has_previous %}class="disabled"{% endif %}>
          <a class="pager_button" href="{% if results.has_previous %}?q={{query}}&page={{ results.previous_page_number }}{% else %}#{% endif %}">&laquo;</a>
      </li>
      
      {# Display ... if we don't see last page #}
      {% if page_numbers|first != 1 %}
      <li class="disabled"><a>...</a></li>
      {% endif %}

      {% for page in page_numbers %}
      <li {% ifequal page results.number %}class="active"{% endifequal %}>
          <a class="pager_button" href="?q={{query}}&page={{ page }}">{{ page }}</a>
      </li>
      {% endfor %}

      {# Display ... if we don't see last page #}
      {% if page_numbers|last != results.paginator.num_pages %}
      <li class="disabled"><a>...</a></li>
      {% endif %}

      <li {% if not results.has_next %}class="disabled"{% endif %}>
          <a class="pager_button" href="{% if results.has_next %}?q={{query}}&page={{ results.next_page_number }}{% else %}#{% endif %}">&raquo;</a>
      </li>
  </ul>
{% endblock %}

{% block extracode %}
  <!-- Modal -->
  <div class="modal fade" id="queryDifficulty" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">What exactly didn't you like about the search results?</h4>
        </div>
        <div class="modal-body">
          <form class="form-horizontal" id="queryDifficultyForm">
            <input type="hidden" name="serpid" value="{{ serpid }}">
            <input type="hidden" id="openTimer" name="openTimer" value="0">
            <fieldset>
            <!-- Multiple Checkboxes -->
            <div class="control-group">
              <div class="controls">
                <div class="checkbox">
                  <label for="query_difficulty-0">
                    <input type="checkbox" name="query_difficulty" id="query_difficulty-0" value="There are documents relevant to the query, but I can get better results by rephrasing my query.">
                      <strong>There are documents relevant</strong> to the query, but I can get better results by rephrasing my query.
                  </label>
                </div>
                <div class="checkbox">
                  <label for="query_difficulty-1">
                    <input type="checkbox" name="query_difficulty" id="query_difficulty-1" value="Documents are missing main topic of the query">
                      Documents <strong>missed</strong> the main topic of the query.
                  </label>
                </div>
                <div class="checkbox">
                  <label for="query_difficulty-6">
                    <input type="checkbox" name="query_difficulty" id="query_difficulty-6" value="Documents are about different interpretation of the main topic of the query.">
                      Documents are about <strong>different interpretation</strong> of the main topic of the query.
                  </label>
                </div>
                <div class="checkbox">
                  <label for="query_difficulty-2">
                    <input type="checkbox" name="query_difficulty" id="query_difficulty-2" value="Documents are missing some aspect (some characteristic of interest) of the main topic of the query.">
                      Documents are missing some <strong>aspect</strong> (some characteristic of interest) of the main topic of the query.
                  </label>
                 </div>
                <div class="checkbox">
                  <label for="query_difficulty-3">
                    <input type="checkbox" name="query_difficulty" id="query_difficulty-3" value="This is a complex query asking about several things and documents missed one of the topics.">
                      This is a complex query asking about several things and documents <strong>missed</strong> one of the topics.
                  </label>
                </div>
                <div class="checkbox">
                  <label for="query_difficulty-7">
                    <input type="checkbox" name="query_difficulty" id="query_difficulty-7" value="This is a complex query asking about several things, but documents are about different interpretation of one of the topics.">
                      This is a complex query asking about several things, but documents are about <strong>different interpretation</strong> of one of the topics.
                  </label>
                </div>
                <div class="checkbox">
                  <label for="query_difficulty-4">
                    <input type="checkbox" name="query_difficulty" id="query_difficulty-4" value="This is a complex query asking about several things and documents missed aspect (some characteristic of interest) of one of the topics.">
                      This is a complex query asking about several things and documents missed <strong>aspect</strong> (some characteristic of interest) of one of the topics.
                  </label>
                </div>
                <div class="checkbox">
                  <label for="query_difficulty-5">
                    <input type="checkbox" name="query_difficulty" id="query_difficulty-5" value="This is a complex query asking about several things and relationship between topics are missing.">
                      This is a complex query asking about several things and <strong>relationship</strong> between topics are missing.
                  </label>
                </div>
                <br />
                <div class="textarea">
                  <textarea rows="3" name="other_reason" class="form-control" id="queryDifficultyTextarea" placeholder="Other reason..."></textarea>
                </div>
              </div>
            </div>

            </fieldset>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="button" id="queryDifficultySubmit" class="btn btn-primary">Submit</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
  <script language="javascript">
    {% if query %}
    function checkUrlForm() {
      if ($('[name="missing[]"]:checked').length == 0 &&
          $('[name="misinterpreted[]"]:checked').length == 0 &&
          $('[name="missing_relation[]"]:checked').length == 0 &&
          $('#extra').val() == "")
        return false;
      return true;
    }

    var timer;

    function incrementTimer() {
        var cur = parseInt($("#openTimer").val());
        $("#openTimer").val(cur + 1);
    }

    $(document).ready(function() {
        $('#search').hide();
        $('#queryText').prop('disabled', true);

        // Query difficulty window timer
        $('#queryDifficulty').on('shown.bs.modal', function() {
            timer = setInterval(incrementTimer, 1000);
        });
        $('#queryDifficulty').on('hidden.bs.modal', function() {
            clearInterval(timer);
        });

        // onclick for query difficulty
        $('#queryDifficultySubmit').on('click', function () {
            var empty = $('#queryDifficultyTextarea').val() == "";
            empty = empty && $(':checkbox:checked').length == 0;
            if (empty) {
                alert("Please choose one or more options before continuing.");
            }
            else {
                $.post("{% url 'querydifficulty:submit_query_difficulty' task_id=task_id %}", 
                    $('#queryDifficultyForm').serialize());
                $('#queryDifficulty').modal('hide');
                $('#queryText').prop('disabled', false);
                $('#queryDifficultyButton').hide();
                $('#search').show();
            }
        });

        $('.pager_button').on('click', function() {
          if (!checkUrlForm()) {
            $('#fillFormAlert').removeClass('hide');
            return false;
          }
          else {
            $.post("{% url 'querydifficulty:submit_url_problem' task_id=task_id %}",
              $('#queryUrlProblemForm').serialize());
          }
        });

    });
    {% else %}
    $('#queryDifficultyButton').hide();
    {% endif %}
  </script>
{% endblock %}